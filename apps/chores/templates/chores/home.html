{% extends "core/base.html" %}

{% block title %}房務管理 | 主頁{% endblock %}

{% block content %}
<style>
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    .red-dot { background-color: #ef4444; }
    .green-dot { background-color: #22c55e; }
    .grey-dot { background-color: #9ca3af; }
</style>

<div class="max-w-7xl mx-auto p-4 md:p-8">

{% if no_room_assigned %}
<div class="text-center p-10 bg-red-100 rounded-lg shadow-md">
    <h2 class="text-2xl font-bold text-red-700">尚未加入房號</h2>
    <p class="text-red-500 mt-2">請先前往成員介面新增或加入房號。</p>
    <a href="/rooms/join/"
       class="mt-4 inline-block px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
       前往加入
    </a>
</div>
{% endif %}

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

<!-- ================= 日曆區 ================= -->
<section class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
    <h2 class="text-2xl font-bold text-gray-800 mb-4">家事頻率與標記</h2>

    <!-- 月曆（桌機） -->
    <div class="hidden lg:block">
        <h3 class="text-lg font-semibold mb-2">月曆</h3>
        <div class="flex items-center justify-between mb-2">
            <button onclick="changeMonth(-1)"
                    class="px-2 py-1 text-sm bg-gray-200 rounded hover:bg-gray-300">
                ◀ 上月
            </button>
        
            <h3 id="calendar-title" class="text-lg font-semibold"></h3>
        
            <button onclick="changeMonth(1)"
                    class="px-2 py-1 text-sm bg-gray-200 rounded hover:bg-gray-300">
                下月 ▶
            </button>
        </div>
        
        <div class="p-4 bg-indigo-50 rounded-lg border border-indigo-200 h-[400px] overflow-y-auto">
            <div id="calendar-content-lg" class="grid grid-cols-7 gap-1 text-center"></div>
        </div>
    </div>

    <!-- 週曆（手機） -->
    <div class="block lg:hidden">
        <h3 class="text-lg font-semibold mb-2">週曆</h3>
        <div class="overflow-x-auto">
            <div id="calendar-content-sm"
                 class="flex space-x-2 p-2 bg-indigo-50 rounded-lg border border-indigo-200">
            </div>
        </div>
    </div>

    <p class="mt-4 text-sm text-gray-500">
        <span class="inline-block w-3 h-3 rounded-full green-dot mr-1"></span>
        今日家事
        <span class="inline-block w-3 h-3 rounded-full red-dot ml-3 mr-1"></span>
        過去未完成
        <span class="inline-block w-3 h-3 rounded-full grey-dot ml-3 mr-1"></span>
        未來家事
    </p>
    
</section>

{{ calendar_data|json_script:"calendar-data" }}

<!-- ================= 右側 ================= -->
<section class="lg:col-span-1 space-y-8">

    <div class="bg-white p-6 rounded-xl shadow-lg">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">今日與積欠事項</h2>
    
        <div class="space-y-4 max-h-96 overflow-y-auto scrollbar-hide pr-2">
            <h3 id="today-count-text" class="text-lg font-semibold text-green-600 border-b pb-1">
                今日事項 ({{ today_chores|length }})
            </h3>
            <div id="today-list-container" class="space-y-3">
                {% for chore in today_chores %}
                <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg border border-green-200 chore-item" data-chore-title="{{ chore.title }}">
                    <div class="flex items-center space-x-3">
                        <input type="checkbox" data-chore-id="{{ chore.id }}"
                               class="form-checkbox h-5 w-5 text-green-600 rounded cursor-pointer btn-complete-ajax">
                        <span class="text-gray-700 font-medium">
                            {{ chore.title }} <span class="text-xs text-green-600">({{ chore.get_type_display }})</span>
                        </span>
                    </div>
                    <span class="text-xs font-bold text-green-500">今天</span>
                </div>
                {% empty %}
                <p class="text-gray-500 py-2 no-data-msg">今日無待辦事項！</p>
                {% endfor %}
            </div>
    
            <h3 id="overdue-count-text" class="text-lg font-semibold text-red-600 border-b pb-1 pt-4">
                積欠事項 ({{ overdue_chores|length }})
            </h3>
            <div id="overdue-list-container" class="space-y-3">
                {% for chore in overdue_chores %}
                <div class="flex items-center justify-between p-3 bg-red-50 rounded-lg border border-red-200 chore-item" data-chore-title="{{ chore.title }}">
                    <div class="flex items-center space-x-3">
                        <input type="checkbox" data-chore-id="{{ chore.id }}"
                               class="form-checkbox h-5 w-5 text-red-600 rounded cursor-pointer btn-complete-ajax">
                        <span class="text-red-700 font-bold">
                            {{ chore.title }} <span class="text-xs opacity-75">({{ chore.get_type_display }})</span>
                        </span>
                    </div>
                    <span class="px-2 py-1 bg-red-600 text-white text-[10px] rounded-full uppercase">逾期</span>
                </div>
                {% empty %}
                <p class="text-gray-500 py-2 no-data-msg">沒有積欠的家務！</p>
                {% endfor %}
            </div>
        </div>
    </div>
    


<!-- 留言板 -->
<div class="bg-white p-6 rounded-xl shadow-lg">
    <h2 class="text-2xl font-bold text-gray-800 mb-4">留言布告欄</h2>

    <div class="space-y-4 max-h-72 overflow-y-auto scrollbar-hide">
        {% for m in bulletin %}
        <div class="p-3 bg-gray-100 rounded-lg hover:bg-gray-200 cursor-pointer"
             onclick="showModal('{{ m.title }}', '{{ m.content }}')">
            <p class="font-semibold truncate">{{ m.title }}</p>
            <span class="text-sm text-gray-500">
                作者 {{ m.author }}，{{ m.time_ago }}
            </span>
        </div>
        {% endfor %}
    </div>

    <a href="{% url 'chats:create' %}">
        <button class="mt-4 w-full px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600">
            發佈新留言
        </button>
    </a>
</div>

</section>
</div>

<!-- ================= Modal ================= -->
<div id="modal-backdrop"
     class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50">
    <div class="bg-white p-6 rounded-xl shadow-2xl w-11/12 md:w-1/2 max-h-5/6 overflow-y-auto">
        <h3 id="modal-title" class="text-xl font-bold mb-4"></h3>
        <div id="modal-body" class="space-y-2 text-gray-600"></div>
        <button onclick="hideModal()"
                class="mt-6 px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 float-right">
            關閉
        </button>
    </div>
</div>

</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let currentYear, currentMonth;
    // 讀取初始月曆資料
    let CALENDAR_DATA = JSON.parse(document.getElementById("calendar-data").textContent);
    
    document.addEventListener("DOMContentLoaded", () => {
        const now = new Date();
        currentYear = now.getFullYear();
        currentMonth = now.getMonth();
    
        // 初始渲染
        refreshAllCalendars();
    
        // 綁定所有勾選框點擊事件 (使用事件代理，避免動態生成失效)
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('btn-complete-ajax')) {
                handleChoreCompletion(e.target);
            }
        });
    });
    
    // 統一渲染入口
    function refreshAllCalendars() {
        renderCalendarMonthly("calendar-content-lg");
        renderCalendarWeekly("calendar-content-sm");
    }
    
    async function handleChoreCompletion(checkbox) {
        if (!checkbox.checked) return;
    
        const choreId = checkbox.dataset.choreId;
        const itemContainer = checkbox.closest('.chore-item');
        const choreTitle = itemContainer.dataset.choreTitle;
    
        try {
            const response = await fetch(`/chores/complete/${choreId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            });
    
            const data = await response.json();
    
            if (data.status === 'success') {
                // 1. 右側列表動畫消失
                itemContainer.style.transition = 'all 0.4s ease';
                itemContainer.style.opacity = '0';
                itemContainer.style.transform = 'translateX(20px)';
    
                setTimeout(() => {
                    itemContainer.remove();
                    updateTextCounters();
                    
                    // 2. 同步月曆資料：將該家務在「今天以前（含今天）」的所有點點顏色改為 Done
                    const todayStr = new Date().toLocaleDateString('sv-SE');
                    CALENDAR_DATA = CALENDAR_DATA.map(event => {
                        if (event.title === choreTitle && event.date <= todayStr) {
                            return { ...event, color: 'done' }; // 狀態改為已完成
                        }
                        return event;
                    });
                    
                    // 3. 重新渲染月曆與週曆，這會讓紅點變不見或變色
                    refreshAllCalendars();
                    
                    // 4. 更新圓餅圖 (如果有定義該 API)
                    if (typeof refreshChoreStats === 'function') {
                        refreshChoreStats();
                    }
    
                }, 400);
            } else {
                alert("更新失敗：" + data.message);
                checkbox.checked = false;
            }
        } catch (err) {
            console.error("網路錯誤", err);
            checkbox.checked = false;
        }
    }
    
    // 更新標題數量文字 (例如：今日事項 (1) -> (0))
    function updateTextCounters() {
        const todayItems = document.querySelectorAll('#today-list-container .chore-item').length;
        const overdueItems = document.querySelectorAll('#overdue-list-container .chore-item').length;
        
        const todayHeader = document.getElementById('today-count-text');
        const overdueHeader = document.getElementById('overdue-count-text');
    
        if (todayHeader) todayHeader.innerText = `今日事項 (${todayItems})`;
        if (overdueHeader) overdueHeader.innerText = `積欠事項 (${overdueItems})`;
    
        if (todayItems === 0) {
            document.getElementById('today-list-container').innerHTML = '<p class="text-gray-500 py-2 no-data-msg">今日無待辦事項！</p>';
        }
        if (overdueItems === 0) {
            document.getElementById('overdue-list-container').innerHTML = '<p class="text-gray-500 py-2 no-data-msg">沒有積欠的家務！</p>';
        }
    }
    
    /* ========== 月曆（桌機）渲染 ========== */
    function renderCalendarMonthly(id) {
        const el = document.getElementById(id);
        if (!el) return;
        
        document.getElementById("calendar-title").textContent = `${currentYear} 年 ${currentMonth + 1} 月`;
        const todayStr = new Date().toLocaleDateString('sv-SE');
        const firstDay = new Date(currentYear, currentMonth, 1).getDay();
        const lastDate = new Date(currentYear, currentMonth + 1, 0).getDate();
    
        const events = {};
        CALENDAR_DATA.forEach(e => {
            if (!events[e.date]) events[e.date] = [];
            events[e.date].push(e);
        });
    
        el.innerHTML = `<div class="font-bold">日</div><div class="font-bold">一</div><div class="font-bold">二</div><div class="font-bold">三</div><div class="font-bold">四</div><div class="font-bold">五</div><div class="font-bold">六</div>`;
    
        for (let i = 0; i < firstDay; i++) el.innerHTML += `<div class="h-20 bg-gray-50/50"></div>`;
    
        for (let d = 1; d <= lastDate; d++) {
            const cur = new Date(currentYear, currentMonth, d);
            const dStr = cur.toLocaleDateString('sv-SE');
            const list = events[dStr] || [];
            const isToday = dStr === todayStr;
    
            // 過濾掉已完成的，或者你可以保留已完成但用不同顏色(如 blue-dot)
            const body = list.map(e => {
                const dotClass = e.color.toLowerCase() === 'done' ? 'bg-indigo-400' : `${e.color.toLowerCase()}-dot`;
                return `
                    <div class="flex items-center space-x-1">
                        <span class="w-2 h-2 rounded-full ${dotClass}"></span>
                        <span class="text-xs truncate ${e.color.toLowerCase() === 'done' ? 'line-through text-gray-300' : ''}">${e.title}</span>
                    </div>`;
            }).join("");
    
            el.innerHTML += `
                <div class="p-1 h-20 border rounded-md ${isToday ? "bg-indigo-50 border-indigo-400" : "bg-white"}">
                    <div class="text-xs font-bold ${isToday ? "text-indigo-600" : "text-gray-400"}">${d}</div>
                    <div class="mt-1 overflow-hidden">${body}</div>
                </div>`;
        }
    }
    
    /* ========== 週曆（手機）渲染 ========== */
    function renderCalendarWeekly(id) {
        const el = document.getElementById(id);
        if (!el) return;
        el.innerHTML = ""; // 清空舊的
    
        const today = new Date();
        const events = {};
        CALENDAR_DATA.forEach(e => {
            if (!events[e.date]) events[e.date] = [];
            events[e.date].push(e);
        });
    
        for (let i = 0; i < 7; i++) {
            const cur = new Date(today);
            cur.setDate(today.getDate() + i);
            const dStr = cur.toLocaleDateString('sv-SE');
            const list = events[dStr] || [];
    
            let dotHtml = "";
            if (list.length > 0) {
                // 只要有任何一項沒完成，就顯示顏色點，全部完成則變淡或隱藏
                const hasPending = list.some(e => e.color.toLowerCase() !== 'done');
                const colorClass = hasPending ? (list[0].color.toLowerCase() + "-dot") : "bg-gray-200";
                dotHtml = `<span class="inline-block w-3 h-3 rounded-full ${colorClass}"></span>`;
            }
    
            el.innerHTML += `
                <div class="flex-shrink-0 w-24 p-2 rounded-lg border text-center ${i === 0 ? "bg-indigo-100 border-indigo-500" : "bg-white"}">
                    <p class="text-sm text-gray-500">${cur.toLocaleDateString("zh-TW",{weekday:"short"})}</p>
                    <p class="text-xl font-bold text-gray-800">${cur.getDate()}</p>
                    ${dotHtml}
                </div>`;
        }
    }
    
    function changeMonth(delta) {
        currentMonth += delta;
        if (currentMonth < 0) { currentMonth = 11; currentYear--; }
        else if (currentMonth > 11) { currentMonth = 0; currentYear++; }
        renderCalendarMonthly("calendar-content-lg");
    }
    </script>
{% endblock %}
