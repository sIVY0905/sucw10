{% extends "core/base.html" %}

{% block title %}房務管理 | 主頁{% endblock %}

{% block content %}
<style>
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    .red-dot { background-color: #ef4444; }
    .green-dot { background-color: #22c55e; }
    .grey-dot { background-color: #9ca3af; }
</style>

<div class="max-w-7xl mx-auto p-4 md:p-8">

    {% if no_room_assigned %}
        <div class="text-center p-10 bg-red-100 rounded-lg shadow-md">
            <h2 class="text-2xl font-bold text-red-700">尚未加入房號</h2>
            <p class="text-red-500 mt-2">請先前往成員介面新增或加入房號。</p>
            <a href="/rooms/join/" class="mt-4 inline-block px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">前往加入</a>
        </div>
    {% endif %}

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

        <!-- 日曆區塊 -->
        <section class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">家事頻率與標記</h2>

            <!-- 月曆（電腦） -->
            <div class="hidden lg:block">
                <h3 class="text-lg font-semibold mb-2">月曆</h3>
                <div class="p-4 bg-indigo-50 rounded-lg border border-indigo-200 h-[400px] overflow-y-auto">
                    <div id="calendar-content-lg" class="grid grid-cols-7 gap-1 text-center">
                        <div class="font-bold">日</div>
                        <div class="font-bold">一</div>
                        <div class="font-bold">二</div>
                        <div class="font-bold">三</div>
                        <div class="font-bold">四</div>
                        <div class="font-bold">五</div>
                        <div class="font-bold">六</div>
                    </div>
                </div>
            </div>

            <!-- 週曆（手機） -->
            <div class="block lg:hidden">
                <h3 class="text-lg font-semibold mb-2">週曆</h3>
                <div class="overflow-x-auto">
                    <div id="calendar-content-sm" class="flex space-x-2 p-2 bg-indigo-50 rounded-lg border border-indigo-200"></div>
                </div>
            </div>

            <p class="mt-4 text-sm text-gray-500">
                <span class="inline-block w-3 h-3 rounded-full green-dot mr-1"></span> 今日 / 第一次逾期
                <span class="inline-block w-3 h-3 rounded-full red-dot ml-3 mr-1"></span> 第二次逾期
                <span class="inline-block w-3 h-3 rounded-full grey-dot ml-3 mr-1"></span> 未來
            </p>
        </section>

        <!-- Django 傳入的日曆資料 -->
        {{ calendar_data|json_script:"calendar-data" }}


        <!-- 右側區：待辦事項與留言 -->
        <section class="lg:col-span-1 space-y-8">

            <!-- 待辦列表 -->
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">今日與積欠事項</h2>
                <div class="space-y-4 max-h-96 overflow-y-auto scrollbar-hide pr-2">

                    <h3 class="text-lg font-semibold text-green-600 border-b pb-1">今日事項 ({{ today_chores|length }})</h3>
                    {% for chore in today_chores %}
                        <div class="flex items-center space-x-3 p-2 bg-green-50 rounded-lg border border-green-200">
                            <input type="checkbox" data-chore-id="{{ chore.id }}" class="form-checkbox h-5 w-5 text-green-600 rounded">
                            <span class="text-gray-700 font-medium">{{ chore.title }} ({{ chore.type }})</span>
                        </div>
                    {% empty %}
                        <p class="text-gray-500">今日無待辦事項！</p>
                    {% endfor %}

                    <h3 class="text-lg font-semibold text-red-600 border-b pb-1 pt-4">積欠事項 ({{ overdue_chores|length }})</h3>
                    {% for chore in overdue_chores %}
                        <div class="flex items-center space-x-3 p-2 bg-red-50 rounded-lg border border-red-200">
                            <input type="checkbox" data-chore-id="{{ chore.id }}" class="form-checkbox h-5 w-5 text-red-600 rounded">
                            <span class="text-gray-700 font-medium line-through">{{ chore.title }} ({{ chore.type }})</span>
                        </div>
                    {% empty %}
                        <p class="text-gray-500">沒有積欠的家務！</p>
                    {% endfor %}
                </div>
            </div>

            <!-- 留言區 -->
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">留言布告欄</h2>
                <div id="bulletin-board-content" class="space-y-4 max-h-72 overflow-y-auto scrollbar-hide">
                    {% for m in bulletin %}
                        <div class="p-3 bg-gray-100 rounded-lg hover:bg-gray-200 cursor-pointer transition"
                             onclick="showModal('{{ m.title }}', '{{ m.content }}')">
                            <p class="font-semibold text-gray-800 truncate">{{ m.title }}</p>
                            <span class="text-sm text-gray-500">作者 {{ m.author }}, {{ m.time_ago }}</span>
                        </div>
                    {% endfor %}
                </div>

                <a href="{% url 'chats:create' %}">
                    <button class="mt-4 w-full px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600">
                        發佈新留言
                    </button>
                </a>
            </div>
        </section>
    </div>

    <!-- 模態框 -->
    <div id="modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50">
        <div id="modal-content" class="bg-white p-6 rounded-xl shadow-2xl w-11/12 md:w-1/2 max-h-5/6 overflow-y-auto">
            <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-4"></h3>
            <div id="modal-body" class="text-gray-600 space-y-3"></div>
            <button class="mt-6 px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 float-right" onclick="hideModal()">關閉</button>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_scripts %}
<script>
/* =============================
     從 Django 傳入 JSON
============================= */
const CALENDAR_DATA = JSON.parse(document.getElementById("calendar-data").textContent);
const DUTY_ROSTER = JSON.parse('{{ duty_roster_json|safe }}');
const TODAY_STR = new Date().toISOString().split("T")[0];

/* =============================
     模態框
============================= */
function showModal(title, bodyHtml) {
    document.getElementById('modal-title').innerHTML = title;
    document.getElementById('modal-body').innerHTML = bodyHtml;
    document.getElementById('modal-backdrop').classList.remove('hidden');
}
function hideModal() {
    document.getElementById('modal-backdrop').classList.add('hidden');
}

/* =============================
     值日生表
============================= */
document.getElementById("duty-roster-btn").addEventListener("click", () => {
    let html = `<p>今日 (${TODAY.toLocaleDateString("zh-TW")}) 分工：</p><ul class="list-disc ml-4">`;

    if (DUTY_ROSTER.length === 0)
        html += `<li class="text-red-500">本房號無家事或無成員。</li>`;
    else
        DUTY_ROSTER.forEach(item => html += `<li><b>${item.chore}</b>：${item.duty_member}</li>`);

    html += "</ul>";

    showModal("今日值日生表", html);
});

/* =============================
     CSRF
============================= */
function getCookie(name){
    let cookieValue = null;
    if (document.cookie !== ''){
        const cookies = document.cookie.split(';');
        for (let c of cookies){
            c = c.trim();
            if (c.startsWith(name + "=")){
                cookieValue = decodeURIComponent(c.substring(name.length + 1));
            }
        }
    }
    return cookieValue;
}

/* =============================
     勾選完成家務
============================= */
document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
    cb.addEventListener("change", function () {
        const id = this.dataset.choreId;

        fetch(`/chores/complete/${id}/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": getCookie("csrftoken"),
                "Content-Type": "application/json"
            }
        }).then(res => res.json())
        .then(() => this.closest("div").remove())
        .catch(() => {
            alert("完成家務失敗");
            this.checked = false;
        });
    });
});

/* =============================
     日曆函式
============================= */


const getDateString = d => d.toISOString().split("T")[0];

function renderCalendarMonthly(id) {
    const container = document.getElementById(id);
    if (!container) return;

    const now = new Date();
    // 獲取本月第一天是星期幾，以及本月最後一天
    const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).getDay();
    const lastDate = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();

    // 建立事件索引快速查找
    const events = {};
    CALENDAR_DATA.forEach(e => {
        if (!events[e.date]) events[e.date] = [];
        events[e.date].push(e);
    });

    container.innerHTML = `
        <div class="font-bold">日</div><div class="font-bold">一</div>
        <div class="font-bold">二</div><div class="font-bold">三</div>
        <div class="font-bold">四</div><div class="font-bold">五</div>
        <div class="font-bold">六</div>
    `;

    // 1. 空白補齊 (上個月的尾巴)
    for (let i = 0; i < firstDay; i++) {
        container.innerHTML += `<div class="h-20 bg-gray-50/50"></div>`;
    }

    // 2. 渲染每一天
    for (let day = 1; day <= lastDate; day++) {
        const curDateObj = new Date(now.getFullYear(), now.getMonth(), day);
        // 修正時區偏移的日期字串格式 YYYY-MM-DD
        const dStr = curDateObj.toLocaleDateString('sv-SE'); 
        
        const list = events[dStr] || [];
        const isToday = dStr === TODAY_STR;

        container.innerHTML += `
            <div class="p-1 h-20 border rounded-md text-left transition hover:bg-gray-50
                ${isToday ? "bg-indigo-50 border-indigo-400 ring-1 ring-indigo-200" : "bg-white"}">
                <div class="text-xs font-bold ${isToday ? "text-indigo-600" : "text-gray-400"}">${day}</div>
                <div class="mt-1 space-y-0.5 overflow-hidden">
                    ${list.slice(0, 2).map(e => `
                        <div class="flex items-center space-x-1">
                            <span class="w-2 h-2 rounded-full ${e.status}-dot flex-shrink-0"></span>
                            <span class="text-[10px] truncate">${e.title}</span>
                        </div>
                    `).join("")}
                    ${list.length > 2 ? `<span class="text-[9px] text-gray-400">還有 ${list.length - 2} 項...</span>` : ""}
                </div>
            </div>
        `;
    }
}

function renderCalendarWeekly(id) {
    const container = document.getElementById(id);
    if (!container) return;

    const today = new Date();
    const events = {};

    CALENDAR_DATA.forEach(e => {
        if (!events[e.date]) events[e.date] = [];
        events[e.date].push(e);
    });

    for (let i = 0; i < 7; i++) {
        const cur = new Date(today);
        cur.setDate(today.getDate() + i);

        const d = getDateString(cur);
        const list = events[d] || [];

        let status = "grey";
        if (list.some(e => e.status === "red")) status = "red";
        else if (list.some(e => e.status === "green")) status = "green";

        container.innerHTML += `
            <div class="flex-shrink-0 w-24 p-2 rounded-lg border text-center
                ${i === 0 ? "bg-indigo-200 border-indigo-500" : "bg-white"}">
                <p class="text-sm">${cur.toLocaleDateString("zh-TW", { weekday: "short" })}</p>
                <p class="text-xl font-bold">${cur.getDate()}</p>
                <span class="inline-block w-3 h-3 rounded-full ${status}-dot mt-1"></span>
            </div>
        `;
    }
}

document.addEventListener('DOMContentLoaded', () => {
    renderCalendarMonthly("calendar-content-lg");
    renderCalendarWeekly("calendar-content-sm");
});
</script>
{% endblock %}
